// üì± –ú–û–ë–ò–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –î–õ–Ø TELEGRAM WEBAPP
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä—è–º–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

// –°–æ–∑–¥–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –ø–∞–Ω–µ–ª—å
function createDiagnosticPanel() {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingPanel = document.getElementById('diagnosticPanel');
    if (existingPanel) {
        existingPanel.remove();
    }

    const panel = document.createElement('div');
    panel.id = 'diagnosticPanel';
    panel.style.cssText = `
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: #1a1a1a;
        color: #00ff00;
        padding: 15px;
        border-radius: 10px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        max-height: 80vh;
        overflow-y: auto;
        border: 2px solid #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    `;

    const header = document.createElement('div');
    header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #00ff00;
    `;
    
    const title = document.createElement('h3');
    title.textContent = 'üîç TELEGRAM WEBAPP DIAGNOSTICS';
    title.style.cssText = 'margin: 0; color: #00ff00;';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '‚ùå';
    closeBtn.style.cssText = `
        background: #ff0000;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    `;
    closeBtn.onclick = () => panel.remove();
    
    header.appendChild(title);
    header.appendChild(closeBtn);
    
    const content = document.createElement('div');
    content.id = 'diagnosticContent';
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.style.cssText = `
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
    `;
    
    // –ö–Ω–æ–ø–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    const buttons = [
        { text: 'üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', action: 'fullDiagnostic' },
        { text: 'üë• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', action: 'checkUsers' },
        { text: 'üîß –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', action: 'syncUser' },
        { text: 'üìä –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏', action: 'testLoad' },
        { text: 'üîí –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –ë–î', action: 'fixRLS' },
        { text: 'üîç –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', action: 'detailedSync' },
        { text: 'üß™ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç', action: 'createTest' },
        { text: 'üîÑ –û—á–∏—Å—Ç–∏—Ç—å', action: 'clear' }
    ];
    
    buttons.forEach(btn => {
        const button = document.createElement('button');
        button.textContent = btn.text;
        button.style.cssText = `
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        `;
        button.onclick = () => handleDiagnosticAction(btn.action);
        buttonsDiv.appendChild(button);
    });
    
    panel.appendChild(header);
    panel.appendChild(buttonsDiv);
    panel.appendChild(content);
    document.body.appendChild(panel);
    
    return content;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
async function handleDiagnosticAction(action) {
    const content = document.getElementById('diagnosticContent');
    
    switch (action) {
        case 'clear':
            content.innerHTML = '';
            break;
        case 'fullDiagnostic':
            await runFullMobileDiagnostic();
            break;
        case 'checkUsers':
            await checkUsersVisual();
            break;
        case 'testLoad':
            await testLoadVisual();
            break;
        case 'createTest':
            await createTestVisual();
            break;
        case 'syncUser':
            await syncUserVisual();
            break;
        case 'fixRLS':
            await fixRLSVisual();
            break;
        case 'detailedSync':
            await detailedSyncVisual();
            break;
    }
}

// –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª—å
function addDiagnosticMessage(message, type = 'info') {
    const content = document.getElementById('diagnosticContent');
    if (!content) return;
    
    const colors = {
        info: '#00ff00',
        error: '#ff0000',
        warning: '#ffff00',
        success: '#00ff00'
    };
    
    const div = document.createElement('div');
    div.style.cssText = `
        margin: 5px 0;
        padding: 5px;
        color: ${colors[type] || colors.info};
        border-left: 3px solid ${colors[type] || colors.info};
        padding-left: 10px;
    `;
    div.textContent = message;
    content.appendChild(div);
    content.scrollTop = content.scrollHeight;
}

// –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
async function runFullMobileDiagnostic() {
    addDiagnosticMessage('üîç Starting full diagnostic...', 'info');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const isTelegram = !!(window.Telegram && window.Telegram.WebApp);
    addDiagnosticMessage(`üì± Telegram WebApp: ${isTelegram ? '‚úÖ YES' : '‚ùå NO'}`, isTelegram ? 'success' : 'error');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase
    const hasSupabase = !!window.supabase;
    addDiagnosticMessage(`üíæ Supabase: ${hasSupabase ? '‚úÖ YES' : '‚ùå NO'}`, hasSupabase ? 'success' : 'error');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ UserManager
    const hasUserManager = !!(window.userManager && window.userManager.isInitialized);
    addDiagnosticMessage(`üë§ UserManager: ${hasUserManager ? '‚úÖ READY' : '‚ùå NOT READY'}`, hasUserManager ? 'success' : 'error');
    
    if (hasUserManager) {
        const user = window.userManager.getCurrentUser();
        let userId = window.userManager.getUserId();
        const telegramId = window.userManager.getTelegramId();
        
        addDiagnosticMessage(`üë§ User Type: ${user?.type || 'unknown'}`, 'info');
        addDiagnosticMessage(`üë§ Telegram ID: ${telegramId || 'none'}`, 'info');
        addDiagnosticMessage(`üë§ User UUID (before): ${userId || 'none'}`, userId ? 'success' : 'error');
        
        // –ï—Å–ª–∏ UUID –Ω–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º ensureUserInDatabase
        if (!userId && hasSupabase) {
            addDiagnosticMessage('üîß Forcing user database sync...', 'warning');
            try {
                await window.userManager.ensureUserInDatabase();
                userId = window.userManager.getUserId();
                addDiagnosticMessage(`üë§ User UUID (after sync): ${userId || 'still none'}`, userId ? 'success' : 'error');
            } catch (err) {
                addDiagnosticMessage(`‚ùå Error syncing user: ${err.message}`, 'error');
            }
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    const strategiesCount = window.strategies ? window.strategies.length : 0;
    addDiagnosticMessage(`üìä Local Strategies: ${strategiesCount}`, strategiesCount > 0 ? 'success' : 'warning');
    
    addDiagnosticMessage('‚úÖ Full diagnostic completed', 'success');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function checkUsersVisual() {
    addDiagnosticMessage('üë• Checking users in database...', 'info');
    
    if (!window.supabase) {
        addDiagnosticMessage('‚ùå Supabase not available', 'error');
        return;
    }
    
    try {
        const { data: users, error } = await window.supabase
            .from('users')
            .select('*');
        
        if (error) {
            addDiagnosticMessage(`‚ùå Error: ${error.message}`, 'error');
        } else {
            addDiagnosticMessage(`üë• Total users in DB: ${users?.length || 0}`, 'success');
            
            if (users && users.length > 0) {
                users.forEach((user, index) => {
                    addDiagnosticMessage(`  ${index + 1}. ID: ${user.telegram_id}, Name: ${user.first_name || 'Unknown'}`, 'info');
                });
            }
        }
    } catch (err) {
        addDiagnosticMessage(`‚ùå Exception: ${err.message}`, 'error');
    }
}

// –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
async function testLoadVisual() {
    addDiagnosticMessage('üìä Testing strategies load...', 'info');
    
    if (!window.userManager || !window.userManager.isInitialized) {
        addDiagnosticMessage('‚ùå User manager not ready', 'error');
        return;
    }
    
    const userId = window.userManager.getUserId();
    addDiagnosticMessage(`üë§ Loading for user: ${userId}`, 'info');
    
    if (!userId) {
        addDiagnosticMessage('‚ùå No user ID available', 'error');
        return;
    }
    
    try {
        const { data, error } = await window.supabase
            .from('strategies')
            .select('*')
            .eq('user_id', userId);
        
        if (error) {
            addDiagnosticMessage(`‚ùå Load error: ${error.message}`, 'error');
        } else {
            addDiagnosticMessage(`‚úÖ Found ${data?.length || 0} strategies`, 'success');
            
            if (data && data.length > 0) {
                data.forEach((strategy, index) => {
                    addDiagnosticMessage(`  ${index + 1}. ${strategy.name}`, 'info');
                });
            }
        }
    } catch (err) {
        addDiagnosticMessage(`‚ùå Exception: ${err.message}`, 'error');
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
async function createTestVisual() {
    addDiagnosticMessage('üß™ Creating test strategy...', 'info');
    
    if (!window.userManager || !window.userManager.isInitialized) {
        addDiagnosticMessage('‚ùå User manager not ready', 'error');
        return;
    }
    
    const userId = window.userManager.getUserId();
    if (!userId) {
        addDiagnosticMessage('‚ùå No user ID available', 'error');
        return;
    }
    
    try {
        const testStrategy = {
            name: `Test Strategy ${Date.now()}`,
            description: 'Mobile diagnostic test',
            fields: [{
                name: 'Test Field',
                description: 'Test',
                inputs: [{
                    type: 'text',
                    label: 'Test Input',
                    required: true
                }]
            }],
            user_id: userId
        };
        
        const { data, error } = await window.supabase
            .from('strategies')
            .insert(testStrategy)
            .select()
            .single();
        
        if (error) {
            addDiagnosticMessage(`‚ùå Create error: ${error.message}`, 'error');
        } else {
            addDiagnosticMessage(`‚úÖ Test strategy created: ${data.name}`, 'success');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            if (typeof loadStrategiesFromDatabase === 'function') {
                await loadStrategiesFromDatabase();
                addDiagnosticMessage('üîÑ Strategies reloaded', 'info');
            }
        }
    } catch (err) {
        addDiagnosticMessage(`‚ùå Exception: ${err.message}`, 'error');
    }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function syncUserVisual() {
    addDiagnosticMessage('üîß Syncing user with database...', 'info');
    
    if (!window.userManager || !window.userManager.isInitialized) {
        addDiagnosticMessage('‚ùå User manager not ready', 'error');
        return;
    }
    
    if (!window.supabase) {
        addDiagnosticMessage('‚ùå Supabase not available', 'error');
        return;
    }
    
    try {
        const beforeUserId = window.userManager.getUserId();
        addDiagnosticMessage(`üë§ UUID before sync: ${beforeUserId || 'none'}`, 'info');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        await window.userManager.ensureUserInDatabase();
        
        const afterUserId = window.userManager.getUserId();
        addDiagnosticMessage(`üë§ UUID after sync: ${afterUserId || 'still none'}`, afterUserId ? 'success' : 'error');
        
        if (afterUserId) {
            addDiagnosticMessage('‚úÖ User sync successful!', 'success');
            
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            if (typeof loadStrategiesFromDatabase === 'function') {
                addDiagnosticMessage('üîÑ Reloading strategies...', 'info');
                await loadStrategiesFromDatabase();
                const strategiesCount = window.strategies ? window.strategies.length : 0;
                addDiagnosticMessage(`üìä Strategies loaded: ${strategiesCount}`, strategiesCount > 0 ? 'success' : 'warning');
            }
        } else {
            addDiagnosticMessage('‚ùå User sync failed - UUID still missing', 'error');
        }
        
    } catch (err) {
        addDiagnosticMessage(`‚ùå Sync error: ${err.message}`, 'error');
    }
}

// –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ RLS (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ RLS)
async function fixRLSVisual() {
    addDiagnosticMessage('üîí Testing database access without RLS...', 'info');
    
    if (!window.supabase) {
        addDiagnosticMessage('‚ùå Supabase not available', 'error');
        return;
    }
    
    try {
        addDiagnosticMessage('üìä Trying direct strategies access...', 'info');
        
        // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const { data: allStrategies, error: allError } = await window.supabase
            .from('strategies')
            .select('*');
        
        if (allError) {
            addDiagnosticMessage(`‚ùå Direct access error: ${allError.message}`, 'error');
            addDiagnosticMessage('üìù Error details: ' + JSON.stringify(allError), 'error');
        } else {
            addDiagnosticMessage(`‚úÖ Direct access works! Found ${allStrategies?.length || 0} total strategies`, 'success');
            
            if (allStrategies && allStrategies.length > 0) {
                addDiagnosticMessage('üìä Strategies in database:', 'info');
                allStrategies.forEach((strategy, index) => {
                    addDiagnosticMessage(`  ${index + 1}. ${strategy.name} (user: ${strategy.user_id})`, 'info');
                });
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ user_id
        if (window.userManager && window.userManager.isInitialized) {
            const userId = window.userManager.getUserId();
            if (userId) {
                addDiagnosticMessage(`üë§ Testing filtered access for user: ${userId}`, 'info');
                
                const { data: userStrategies, error: userError } = await window.supabase
                    .from('strategies')
                    .select('*')
                    .eq('user_id', userId);
                
                if (userError) {
                    addDiagnosticMessage(`‚ùå Filtered access error: ${userError.message}`, 'error');
                } else {
                    addDiagnosticMessage(`‚úÖ Filtered access works! Found ${userStrategies?.length || 0} user strategies`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    if (userStrategies && Array.isArray(userStrategies)) {
                        window.strategies = userStrategies;
                        addDiagnosticMessage(`üîÑ Updated local strategies: ${window.strategies.length}`, 'success');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI
                        if (typeof updateStrategySelect === 'function') {
                            updateStrategySelect();
                        }
                        if (typeof renderStrategies === 'function') {
                            renderStrategies();
                        }
                    }
                }
            }
        }
        
        addDiagnosticMessage('‚úÖ Database access test completed!', 'success');
        
    } catch (err) {
        addDiagnosticMessage(`‚ùå Test error: ${err.message}`, 'error');
    }
}

// –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
async function detailedSyncVisual() {
    addDiagnosticMessage('üîç DETAILED ARCHITECTURE ANALYSIS...', 'info');
    
    if (!window.supabase) {
        addDiagnosticMessage('‚ùå Supabase not available', 'error');
        return;
    }
    
    try {
        // 1. –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î
        addDiagnosticMessage('üë• Step 1: Analyzing all users in database...', 'info');
        
        const { data: allUsers, error: usersError } = await window.supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (usersError) {
            addDiagnosticMessage(`‚ùå Users query error: ${usersError.message}`, 'error');
            return;
        }
        
        addDiagnosticMessage(`üìä Total users in database: ${allUsers?.length || 0}`, 'success');
        
        // –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const browserUsers = allUsers?.filter(u => u.telegram_id < 0) || [];
        const telegramUsers = allUsers?.filter(u => u.telegram_id > 0) || [];
        
        addDiagnosticMessage(`üíª Browser users (negative IDs): ${browserUsers.length}`, 'info');
        addDiagnosticMessage(`üì± Telegram users (positive IDs): ${telegramUsers.length}`, 'info');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (allUsers && allUsers.length > 0) {
            addDiagnosticMessage('üìù Users breakdown:', 'info');
            allUsers.forEach((user, index) => {
                const type = user.telegram_id < 0 ? 'BROWSER' : 'TELEGRAM';
                addDiagnosticMessage(`  ${index + 1}. [${type}] ID: ${user.telegram_id}, Name: ${user.first_name}, UUID: ${user.id.substring(0, 8)}...`, 'info');
            });
        }
        
        // 2. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
        addDiagnosticMessage('üìä Step 2: Analyzing strategies distribution...', 'info');
        
        const { data: allStrategies, error: strategiesError } = await window.supabase
            .from('strategies')
            .select('*, users!inner(telegram_id, first_name)')
            .order('created_at', { ascending: false });
        
        if (strategiesError) {
            addDiagnosticMessage(`‚ùå Strategies query error: ${strategiesError.message}`, 'error');
        } else {
            addDiagnosticMessage(`üìä Total strategies: ${allStrategies?.length || 0}`, 'success');
            
            if (allStrategies && allStrategies.length > 0) {
                const browserStrategies = allStrategies.filter(s => s.users.telegram_id < 0);
                const telegramStrategies = allStrategies.filter(s => s.users.telegram_id > 0);
                
                addDiagnosticMessage(`üíª Browser strategies: ${browserStrategies.length}`, 'info');
                addDiagnosticMessage(`üì± Telegram strategies: ${telegramStrategies.length}`, 'info');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                addDiagnosticMessage('üìù Strategies breakdown:', 'info');
                allStrategies.slice(0, 5).forEach((strategy, index) => {
                    const type = strategy.users.telegram_id < 0 ? 'BROWSER' : 'TELEGRAM';
                    addDiagnosticMessage(`  ${index + 1}. [${type}] "${strategy.name}" by ${strategy.users.first_name}`, 'info');
                });
                
                if (allStrategies.length > 5) {
                    addDiagnosticMessage(`  ... and ${allStrategies.length - 5} more`, 'info');
                }
            }
        }
        
        // 3. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram
        addDiagnosticMessage('üë§ Step 3: Current Telegram user analysis...', 'info');
        
        if (window.userManager && window.userManager.isInitialized) {
            const currentUser = window.userManager.getCurrentUser();
            const telegramId = window.userManager.getTelegramId();
            
            addDiagnosticMessage(`üì± Current Telegram ID: ${telegramId}`, 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
            const existingTelegramUser = allUsers?.find(u => u.telegram_id === telegramId);
            
            if (existingTelegramUser) {
                addDiagnosticMessage(`‚úÖ Telegram user EXISTS in database!`, 'success');
                addDiagnosticMessage(`üë§ User UUID: ${existingTelegramUser.id}`, 'success');
                
                // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º UUID
                window.userManager.currentUser.uuid = existingTelegramUser.id;
                addDiagnosticMessage(`üîß UUID assigned to current user!`, 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userStrategies = allStrategies?.filter(s => s.user_id === existingTelegramUser.id) || [];
                addDiagnosticMessage(`üìä User has ${userStrategies.length} strategies`, userStrategies.length > 0 ? 'success' : 'warning');
                
                if (userStrategies.length > 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    window.strategies = userStrategies;
                    addDiagnosticMessage(`üîÑ Local strategies updated: ${window.strategies.length}`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    if (typeof updateStrategySelect === 'function') {
                        updateStrategySelect();
                    }
                    if (typeof renderStrategies === 'function') {
                        renderStrategies();
                    }
                }
            } else {
                addDiagnosticMessage(`‚ùå Telegram user NOT FOUND in database`, 'error');
                addDiagnosticMessage(`üÜï Need to create user for telegram_id: ${telegramId}`, 'warning');
                
                // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å
                addDiagnosticMessage(`üîß Attempting to create user...`, 'info');
                const success = await window.userManager.ensureUserInDatabase();
                
                if (success) {
                    addDiagnosticMessage(`‚úÖ User created successfully!`, 'success');
                } else {
                    addDiagnosticMessage(`‚ùå User creation failed`, 'error');
                }
            }
        }
        
        addDiagnosticMessage('‚úÖ DETAILED ANALYSIS COMPLETED!', 'success');
        
    } catch (err) {
        addDiagnosticMessage(`‚ùå Analysis error: ${err.message}`, 'error');
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function addDiagnosticButton() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Telegram WebApp
    if (!(window.Telegram && window.Telegram.WebApp)) {
        return;
    }
    
    const button = document.createElement('button');
    button.textContent = 'üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞';
    button.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        cursor: pointer;
        z-index: 9999;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
    `;
    
    button.onclick = () => {
        createDiagnosticPanel();
        setTimeout(runFullMobileDiagnostic, 500);
    };
    
    document.body.appendChild(button);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
setTimeout(() => {
    if (window.Telegram && window.Telegram.WebApp) {
        addDiagnosticButton();
        console.log('üîç Mobile diagnostics ready - look for blue button in bottom right');
    }
}, 3000);

console.log('üì± Mobile diagnostics loaded');
