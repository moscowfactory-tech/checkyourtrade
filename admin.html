<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeAnalyzer - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #ffffff;
            line-height: 1.6;
        }

        .header {
            background: #1a1f2e;
            padding: 1rem 2rem;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #4fd1c7;
            font-size: 1.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #f56565;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            border-color: #4fd1c7;
        }

        .metric-card.clickable {
            cursor: pointer;
        }

        .metric-card.clickable:hover {
            background: #1f2937;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #a0aec0;
            font-weight: 500;
        }

        .metric-icon {
            font-size: 1.2rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.positive {
            color: #48bb78;
        }

        .metric-change.negative {
            color: #f56565;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 1.5rem;
            max-height: 400px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            color: #4fd1c7;
            margin: 0;
            font-size: 1.1rem;
        }

        .period-selector {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .period-selector:focus {
            outline: none;
            border-color: #4fd1c7;
        }

        .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .details-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .details-modal h3 {
            color: #4fd1c7;
            margin-bottom: 1rem;
        }

        .details-list {
            list-style: none;
            padding: 0;
        }

        .details-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #2d3748;
            color: #ffffff;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .period-selector {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #ffffff;
            gap: 2rem;
        }

        .log-card {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            border-left: 3px solid transparent;
        }

        .log-entry.info {
            background: rgba(66, 153, 225, 0.1);
            border-left-color: #4299e1;
        }

        .log-entry.error {
            background: rgba(245, 101, 101, 0.1);
            border-left-color: #f56565;
        }

        .log-entry.success {
            background: rgba(72, 187, 120, 0.1);
            border-left-color: #48bb78;
        }

        .log-timestamp {
            color: #a0aec0;
            font-size: 0.7rem;
        }

        .refresh-btn {
            background: #4fd1c7;
            color: #0f1419;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #38b2ac;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #2d3748;
            border-radius: 50%;
            border-top-color: #4fd1c7;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid #f56565;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #fed7d7;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .logs-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üéØ TradeAnalyzer Admin</h1>
        <div class="status-indicator">
            <div class="status-dot" id="systemStatus"></div>
            <span id="statusText">–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</span>
            <button class="refresh-btn" onclick="refreshData()">
                <span id="refreshIcon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </header>

    <div class="container">
        <!-- –ê–ª–µ—Ä—Ç—ã -->
        <div id="alertsContainer"></div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="metrics-grid">
            <div class="metric-card clickable" onclick="dashboard.showUserDetails('registrations')">
                <div class="metric-header">
                    <span class="metric-title">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏</span>
                    <span class="metric-icon">üë•</span>
                </div>
                <div class="metric-value" id="registrationsCount">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">üìã –°—Ç—Ä–∞—Ç–µ–≥–∏–π —Å–æ–∑–¥–∞–Ω–æ</span>
                    <span class="metric-icon">üìà</span>
                </div>
                <div class="metric-value" id="strategiesCount">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">üîç –ê–Ω–∞–ª–∏–∑—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</span>
                    <span class="metric-icon">üìä</span>
                </div>
                <div class="metric-value" id="analysesCount">
                    <div class="loading"></div>
                </div>
                <div class="metric-change" id="analysesChange"></div>
            </div>

            <div class="metric-card clickable" onclick="dashboard.showUserDetails('active')">
                <div class="metric-header">
                    <span class="metric-title">üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (24—á)</span>
                    <span class="metric-icon">üü¢</span>
                </div>
                <div class="metric-value" id="activeUsers">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">üêõ –û—à–∏–±–∫–∏ (24—á)</span>
                    <span class="metric-icon">‚ö†Ô∏è</span>
                </div>
                <div class="metric-value" id="errorsCount">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">‚ö° –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞</span>
                    <span class="metric-icon">üöÄ</span>
                </div>
                <div class="metric-value" id="responseTime">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <select id="activityPeriod" class="period-selector">
                        <option value="7">7 –¥–Ω–µ–π</option>
                        <option value="30" selected>30 –¥–Ω–µ–π</option>
                        <option value="90">90 –¥–Ω–µ–π</option>
                    </select>
                </div>
                <canvas id="userActivityChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- –õ–æ–≥–∏ –∏ –æ—à–∏–±–∫–∏ -->
        <div class="logs-section">
            <div class="log-card">
                <h3 class="chart-title">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                <div id="recentEvents">
                    <div class="loading"></div>
                </div>
            </div>
            
            <div class="log-card">
                <h3 class="chart-title">üö® –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</h3>
                <div id="recentErrors">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π -->
    <div id="detailsModal" class="details-modal">
        <div class="details-modal-content">
            <button class="close-modal" onclick="dashboard.closeModal()">&times;</button>
            <h3 id="modalTitle">–î–µ—Ç–∞–ª–∏</h3>
            <div id="modalContent">
                <div class="loading"></div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase (–≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        const SUPABASE_URL = 'https://wpexepphsdzwopltunnn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwZXhlcHBoc2R6d29wbHR1bm5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTQ5MjIsImV4cCI6MjA3NDkzMDkyMn0.qrLKaW7zGNK6ak-Ll3VHq-Qr-2O9b9GOsMu87Lfm5M0';

        class AdminDashboard {
            constructor() {
                this.charts = {};
                this.refreshInterval = null;
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupCharts();
                this.startAutoRefresh();
            }

            async loadData() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                    const [
                        activeUsers,
                        registrations,
                        strategies,
                        analyses,
                        errors,
                        events,
                        errorLogs
                    ] = await Promise.all([
                        this.getActiveUsers(),
                        this.getRegistrationsCount(),
                        this.getStrategiesCount(),
                        this.getAnalysesCount(),
                        this.getErrorsCount(),
                        this.getRecentEvents(),
                        this.getRecentErrors()
                    ]);

                    this.updateMetrics({
                        activeUsers,
                        registrations,
                        strategies,
                        analyses,
                        errors
                    });

                    this.updateEvents(events);
                    this.updateErrors(errorLogs);
                    this.updateSystemStatus();

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', error.message);
                }
            }

            async getActiveUsersCount() {
                // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ 24 —á–∞—Å–∞ - —Ç–µ, –∫—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑—ã
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                
                const [strategiesResponse, analysesResponse] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/strategies?select=user_id&created_at=gte.${yesterday}`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }),
                    fetch(`${SUPABASE_URL}/rest/v1/analysis_results?select=user_id&created_at=gte.${yesterday}`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    })
                ]);
                
                const activeUsers = new Set();
                
                if (strategiesResponse.ok) {
                    const strategies = await strategiesResponse.json();
                    strategies.forEach(s => s.user_id && activeUsers.add(s.user_id));
                }
                
                if (analysesResponse.ok) {
                    const analyses = await analysesResponse.json();
                    analyses.forEach(a => a.user_id && activeUsers.add(a.user_id));
                }
                
                return activeUsers.size;
            }

            async getRegistrationsCount() {
                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–∑–¥–∞–≤—à–∏—Ö —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
                const response = await fetch(`${SUPABASE_URL}/rest/v1/strategies?select=user_id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) return 0;
                const data = await response.json();
                // –°—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const uniqueUsers = new Set(data.map(strategy => strategy.user_id));
                return uniqueUsers.size;
            }

            async getStrategiesCount() {
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã strategies
                const response = await fetch(`${SUPABASE_URL}/rest/v1/strategies?select=id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) return 0;
                const data = await response.json();
                return data.length;
            }

            async getAnalysesCount() {
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã analysis_results
                const response = await fetch(`${SUPABASE_URL}/rest/v1/analysis_results?select=id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) return 0;
                const data = await response.json();
                return data.length;
            }

            async getErrorsCount() {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/error_logs?select=count&timestamp=gte.${new Date(Date.now() - 24*60*60*1000).toISOString()}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });
                
                if (!response.ok) return 0;
                
                return parseInt(response.headers.get('content-range').split('/')[1]) || 0;
            }

            async getRecentEvents() {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_events?select=*&order=timestamp.desc&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) return [];
                
                return await response.json();
            }

            async getRecentErrors() {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/error_logs?select=*&order=timestamp.desc&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) return [];
                
                return await response.json();
            }

            async updateMetrics(data) {
                document.getElementById('activeUsers').textContent = data.activeUsers || 0;
                document.getElementById('strategiesCount').textContent = data.strategies || 0;
                document.getElementById('analysesCount').textContent = data.analyses || 0;
                document.getElementById('errorsCount').textContent = data.errors || 0;
                document.getElementById('registrationsCount').textContent = data.registrations || 0;
                // –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ placeholder
                document.getElementById('responseTime').textContent = '< 100ms';
            }

            updateEvents(events) {
                const container = document.getElementById('recentEvents');
                container.innerHTML = '';
                
                events.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'log-entry info';
                    eventEl.innerHTML = `
                        <div class="log-timestamp">${new Date(event.timestamp).toLocaleString('ru-RU')}</div>
                        <div>${this.formatEventName(event.event_name)} - User ${event.user_id?.substring(0, 8)}...</div>
                    `;
                    container.appendChild(eventEl);
                });
            }

            updateErrors(errors) {
                const container = document.getElementById('recentErrors');
                container.innerHTML = '';
                
                if (errors.length === 0) {
                    container.innerHTML = '<div class="log-entry success">üéâ –û—à–∏–±–æ–∫ –Ω–µ—Ç!</div>';
                    return;
                }
                
                errors.forEach(error => {
                    const errorEl = document.createElement('div');
                    errorEl.className = 'log-entry error';
                    errorEl.innerHTML = `
                        <div class="log-timestamp">${new Date(error.timestamp).toLocaleString('ru-RU')}</div>
                        <div><strong>${error.type}</strong>: ${error.message}</div>
                    `;
                    container.appendChild(errorEl);
                });
            }

            formatEventName(eventName) {
                const eventNames = {
                    'session_start': 'üöÄ –°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞',
                    'strategy_created': 'üìù –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ–∑–¥–∞–Ω–∞',
                    'analysis_completed': 'üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω',
                    'user_registered': 'üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                    'premium_purchased': 'üíé –ü—Ä–µ–º–∏—É–º –∫—É–ø–ª–µ–Ω'
                };
                
                return eventNames[eventName] || eventName;
            }

            updateSystemStatus() {
                const statusDot = document.getElementById('systemStatus');
                const statusText = document.getElementById('statusText');
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
                const errorsCount = parseInt(document.getElementById('errorsCount').textContent);
                
                if (errorsCount > 10) {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = '–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã';
                } else {
                    statusDot.className = 'status-dot';
                    statusText.textContent = '–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç';
                }
            }

            async setupCharts() {
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ø–∞—Ä–æ–ª—é (–æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è)
                const ADMIN_PASSWORD = 'trade2024'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å
                if (!window.sessionStorage.getItem('admin_auth')) {
                    const entered = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
                    if (entered !== ADMIN_PASSWORD) {
                        alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
                        window.location.href = '/';
                        return;
                    }
                    window.sessionStorage.setItem('admin_auth', '1');
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
                const periodSelector = document.getElementById('activityPeriod');
                periodSelector.addEventListener('change', () => {
                    this.updateActivityChart();
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                await this.updateActivityChart();
            }

            async updateActivityChart() {
                const periodSelector = document.getElementById('activityPeriod');
                const days = parseInt(periodSelector.value);
                const ctx1 = document.getElementById('userActivityChart').getContext('2d');
                const now = new Date();
                const labels = [];
                const activityCounts = [];
                for (let i = days - 1; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
                    labels.push(d.toLocaleDateString('ru-RU', {weekday: 'short'}));
                    activityCounts.push(0);
                }
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞ 7 –¥–Ω–µ–π (–ª—é–±—ã–µ —Å–æ–±—ã—Ç–∏—è), —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –¥–µ–Ω—å
                const resp = await fetch(`${SUPABASE_URL}/rest/v1/user_events?select=user_id,timestamp&timestamp=gte.${new Date(Date.now() - days*24*60*60*1000).toISOString()}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ user_id
                    const daySets = Array.from({length: days}, () => new Set());
                    data.forEach(ev => {
                        const d = new Date(ev.timestamp);
                        const idx = days - 1 - Math.floor((now - d) / (24*60*60*1000));
                        if (idx >= 0 && idx < days) daySets[idx].add(ev.user_id || 'anon');
                    });
                    daySets.forEach((s, i) => activityCounts[i] = s.size);
                }
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (this.charts.userActivity) {
                    this.charts.userActivity.destroy();
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                this.charts.userActivity = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                            data: activityCounts,
                            borderColor: '#4fd1c7',
                            backgroundColor: 'rgba(79, 209, 199, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {legend: {labels: {color: '#ffffff'}}},
                        scales: {
                            y: {beginAtZero: true, ticks: {color: '#a0aec0'}, grid: {color: '#2d3748'}},
                            x: {ticks: {color: '#a0aec0'}, grid: {color: '#2d3748'}}
                        }
                    }
                });
            }

            async showUserDetails(type) {
                const modal = document.getElementById('detailsModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                modal.style.display = 'block';
                modalContent.innerHTML = '<div class="loading"></div>';
                
                try {
                    if (type === 'registrations') {
                        modalTitle.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏';
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/strategies?select=user_id,users(telegram_id,username,first_name)&order=created_at.desc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const uniqueUsers = new Map();
                            data.forEach(strategy => {
                                if (strategy.user_id && !uniqueUsers.has(strategy.user_id)) {
                                    uniqueUsers.set(strategy.user_id, strategy.users);
                                }
                            });
                            
                            let html = '<ul class="details-list">';
                            uniqueUsers.forEach((user, userId) => {
                                const displayName = user?.first_name || user?.username || `User ${userId}`;
                                html += `<li>üë§ ${displayName} (ID: ${userId})</li>`;
                            });
                            html += '</ul>';
                            modalContent.innerHTML = html;
                        }
                    } else if (type === 'active') {
                        modalTitle.textContent = '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (24—á)';
                        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                        
                        const [strategiesResponse, analysesResponse] = await Promise.all([
                            fetch(`${SUPABASE_URL}/rest/v1/strategies?select=user_id,users(telegram_id,username,first_name),created_at&created_at=gte.${yesterday}`, {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            }),
                            fetch(`${SUPABASE_URL}/rest/v1/analysis_results?select=user_id,users(telegram_id,username,first_name),created_at&created_at=gte.${yesterday}`, {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            })
                        ]);
                        
                        const activeUsers = new Map();
                        
                        if (strategiesResponse.ok) {
                            const strategies = await strategiesResponse.json();
                            strategies.forEach(s => {
                                if (s.user_id) {
                                    activeUsers.set(s.user_id, {
                                        user: s.users,
                                        activity: '–°–æ–∑–¥–∞–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏—é',
                                        time: new Date(s.created_at).toLocaleString('ru-RU')
                                    });
                                }
                            });
                        }
                        
                        if (analysesResponse.ok) {
                            const analyses = await analysesResponse.json();
                            analyses.forEach(a => {
                                if (a.user_id) {
                                    const existing = activeUsers.get(a.user_id);
                                    activeUsers.set(a.user_id, {
                                        user: a.users,
                                        activity: existing ? '–°–æ–∑–¥–∞–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏ –∞–Ω–∞–ª–∏–∑' : '–ü—Ä–æ–≤–µ–ª –∞–Ω–∞–ª–∏–∑',
                                        time: new Date(a.created_at).toLocaleString('ru-RU')
                                    });
                                }
                            });
                        }
                        
                        let html = '<ul class="details-list">';
                        activeUsers.forEach((data, userId) => {
                            const displayName = data.user?.first_name || data.user?.username || `User ${userId}`;
                            html += `<li>üë§ ${displayName}<br><small>${data.activity} - ${data.time}</small></li>`;
                        });
                        html += '</ul>';
                        modalContent.innerHTML = html;
                    }
                } catch (error) {
                    modalContent.innerHTML = `<p style="color: #f56565;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</p>`;
                }
            }

            closeModal() {
                document.getElementById('detailsModal').style.display = 'none';
            }

            showAlert(title, message) {
                const alertsContainer = document.getElementById('alertsContainer');
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <div class="alert-title">${title}</div>
                    <div>${message}</div>
                `;
                alertsContainer.appendChild(alert);
                
                // –£–±–∏—Ä–∞–µ–º –∞–ª–µ—Ä—Ç —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    alert.remove();
                }, 10000);
            }

            startAutoRefresh() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                this.refreshInterval = setInterval(() => {
                    this.loadData();
                }, 30000);
            }

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }
        }

        // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–∞—à–±–æ—Ä–¥–∞
        const dashboard = new AdminDashboard();

        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div>';
            
            await dashboard.loadData();
            
            refreshIcon.innerHTML = 'üîÑ';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AdminDashboard();
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (dashboard) {
                dashboard.stopAutoRefresh();
            }
        });
    </script>
</body>
</html>
